import { otelSDK } from './tracer';

import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { REDIS_HOST, REDIS_PASSWORD, REDIS_PORT } from './env';
import { Transport } from '@nestjs/microservices';
import { DocumentBuilder, SwaggerModule } from '@nestjs/swagger';

const expectedResult = [
  [
    {
      id: 'forum_a544d09f-16fb-441a-8361-e50d0cc6a5ae',
      external_id: 'a544d09f-16fb-441a-8361-e50d0cc6a5ae',
      thread_type: 'forum',
      title: 'Ошибки в работе сайта',
      views: 2316,
      pinned: true,
      admin_only: false,
      lastMessage: {
        id: 'ff8e86ee-e644-468e-ba9e-16e250e799e5',
        author: '1177028171',
        index: 27,
        content: 'Сделать возможность удаления комментариев в профиле',
        created_at: '2024-11-18T19:43:33.604Z',
        deleted: false,
        thread_id: 'forum_a544d09f-16fb-441a-8361-e50d0cc6a5ae',
      },
      messageCount: 28,
      newMessageCount: 0,
      originalPoster: '116514945',
    },
    {
      id: 'forum_c2d67f91-74b0-4587-af06-0c44345eef7f',
      external_id: 'c2d67f91-74b0-4587-af06-0c44345eef7f',
      thread_type: 'forum',
      title: 'Обновления сайта',
      views: 462,
      pinned: true,
      admin_only: true,
      lastMessage: {
        id: '5b3edbe4-4ee6-42b9-83c9-a56e7a04e537',
        author: '116514945',
        index: 3,
        content:
          '12.11.2024\n- Добавлены пуш-уведомления, включить их можно на странице поиска https://dotaclassic.ru/queue\n- Сейчас существует 2 пуш уведомления: когда находится игра, и когда в поиске не хватает нескольких человек. \nВключайте пуш уведомления, если не хотите пропустить игру!',
        created_at: '2024-11-12T18:11:00.915Z',
        deleted: false,
        thread_id: 'forum_c2d67f91-74b0-4587-af06-0c44345eef7f',
      },
      messageCount: 4,
      newMessageCount: 0,
      originalPoster: '116514945',
    },
    {
      id: 'forum_17aa3530-d152-462e-a032-909ae69019ed',
      external_id: '17aa3530-d152-462e-a032-909ae69019ed',
      thread_type: 'forum',
      title: 'Поиск игры',
      views: 63681,
      pinned: false,
      admin_only: false,
      lastMessage: {
        id: '28419b42-e0da-4036-8de0-ce74cf3a800e',
        author: '1699042272',
        index: 4482,
        content: 'аdмин в обучении хах',
        created_at: '2024-11-23T02:10:57.334Z',
        deleted: false,
        thread_id: 'forum_17aa3530-d152-462e-a032-909ae69019ed',
      },
      messageCount: 4483,
      newMessageCount: 8,
      originalPoster: '116514945',
    },
    {
      id: 'forum_86cef1ad-8ef1-41a0-becc-c7bf60772463',
      external_id: '86cef1ad-8ef1-41a0-becc-c7bf60772463',
      thread_type: 'forum',
      title: 'как запустить старую доту?',
      views: 46,
      pinned: false,
      admin_only: false,
      lastMessage: {
        id: 'ca8398d8-d20b-4d76-9389-2b0e3961ffda',
        author: '1017236143',
        index: 1,
        content:
          'так, вроде получилось запустить, всем спасибо все свободны. P.S. Может тему удалит кто-нибудь',
        created_at: '2024-11-21T18:29:32.313Z',
        deleted: false,
        thread_id: 'forum_86cef1ad-8ef1-41a0-becc-c7bf60772463',
      },
      messageCount: 2,
      newMessageCount: 0,
      originalPoster: '1017236143',
    },
    {
      id: 'forum_90a0cb63-b1e0-4590-8669-4da287bcec6f',
      external_id: '90a0cb63-b1e0-4590-8669-4da287bcec6f',
      thread_type: 'forum',
      title: 'помогите игру запустить',
      views: 143,
      pinned: false,
      admin_only: false,
      lastMessage: {
        id: 'a95470ca-b74a-4b75-9368-7c4998f03074',
        author: '116514945',
        index: 6,
        content: 'В настройках графики сделай полный экран или окно без рамки',
        created_at: '2024-11-21T07:10:15.567Z',
        deleted: false,
        thread_id: 'forum_90a0cb63-b1e0-4590-8669-4da287bcec6f',
      },
      messageCount: 7,
      newMessageCount: 0,
      originalPoster: '1700137688',
    },
    {
      id: 'forum_47b0d9d6-7a91-4bb5-984d-1f450743b10c',
      external_id: '47b0d9d6-7a91-4bb5-984d-1f450743b10c',
      thread_type: 'forum',
      title: 'Хускар топ?',
      views: 86,
      pinned: false,
      admin_only: false,
      lastMessage: {
        id: '4decd0bc-672a-4991-a0af-718debc02453',
        author: '1784187735',
        index: 1,
        content:
          'нет лучше врайт кинг и обезательно кричи после каждого крита НА',
        created_at: '2024-11-19T14:33:50.887Z',
        deleted: false,
        thread_id: 'forum_47b0d9d6-7a91-4bb5-984d-1f450743b10c',
      },
      messageCount: 2,
      newMessageCount: 0,
      originalPoster: '1225000368',
    },
    {
      id: 'forum_02acb9c4-2c92-4f49-9896-0f52b1ce2b42',
      external_id: '02acb9c4-2c92-4f49-9896-0f52b1ce2b42',
      thread_type: 'forum',
      title: 'пОЧЕМУ РОЛЬ ТЕРПИЛА НЕ ДОСТАЛАСЬ МНЕ?',
      views: 142,
      pinned: false,
      admin_only: false,
      lastMessage: {
        id: 'f8bb6dec-b990-423e-8178-dd892822be42',
        author: '1126848000',
        index: 1,
        content: 'соси',
        created_at: '2024-11-15T15:23:46.133Z',
        deleted: false,
        thread_id: 'forum_02acb9c4-2c92-4f49-9896-0f52b1ce2b42',
      },
      messageCount: 2,
      newMessageCount: 0,
      originalPoster: '1423605020',
    },
    {
      id: 'forum_7784253b-910a-4a8b-a82d-bb0a49caa043',
      external_id: '7784253b-910a-4a8b-a82d-bb0a49caa043',
      thread_type: 'forum',
      title: 'sadfasf',
      views: 154,
      pinned: false,
      admin_only: false,
      lastMessage: {
        id: '89d51f30-4d52-434a-810a-339110306a51',
        author: '116514945',
        index: 7,
        content: '213123',
        created_at: '2024-11-08T12:15:21.805Z',
        deleted: false,
        thread_id: 'forum_7784253b-910a-4a8b-a82d-bb0a49caa043',
      },
      messageCount: 8,
      newMessageCount: 0,
      originalPoster: '116514945',
    },
    {
      id: 'forum_ffe22189-67bb-49ca-a38a-12c67412ff29',
      external_id: 'ffe22189-67bb-49ca-a38a-12c67412ff29',
      thread_type: 'forum',
      title: 'Важный форум',
      views: 182,
      pinned: false,
      admin_only: false,
      lastMessage: {
        id: 'c108398d-b30e-4c79-bce3-c681ec2c467d',
        author: '110305574',
        index: 1,
        content:
          'Ты такое больше не пиши в интернете.\nТебе должно быть стыдно.\n\nЧесть мундира позоришь.',
        created_at: '2024-10-31T18:28:18.178Z',
        deleted: false,
        thread_id: 'forum_ffe22189-67bb-49ca-a38a-12c67412ff29',
      },
      messageCount: 2,
      newMessageCount: 0,
      originalPoster: '1193166927',
    },
    {
      id: 'forum_ef5ec0da-9b46-4ecd-a6b5-3fa58b6e88b0',
      external_id: 'ef5ec0da-9b46-4ecd-a6b5-3fa58b6e88b0',
      thread_type: 'forum',
      title: 'sadfasf',
      views: 106,
      pinned: false,
      admin_only: false,
      lastMessage: {
        id: '26b81a66-2a19-4427-acf9-31732035eaf8',
        author: '116514945',
        index: 4,
        content: 'asdfasdf\nfasdfasdf',
        created_at: '2024-10-30T20:42:11.496Z',
        deleted: false,
        thread_id: 'forum_ef5ec0da-9b46-4ecd-a6b5-3fa58b6e88b0',
      },
      messageCount: 5,
      newMessageCount: 0,
      originalPoster: '116514945',
    },
    {
      id: 'forum_794ab7f8-9341-4903-a889-c2bda551d93d',
      external_id: '794ab7f8-9341-4903-a889-c2bda551d93d',
      thread_type: 'forum',
      title: 'гена опять запотел в паблике',
      views: 302,
      pinned: false,
      admin_only: false,
      lastMessage: {
        id: '9241ed61-a54a-4c05-82ae-e51696355d4f',
        author: '116514945',
        index: 1,
        content: 'https://www.youtube.com/watch?v=a_Yt149ExB4&ab_channel=Nix',
        created_at: '2024-10-30T18:33:07.063Z',
        deleted: false,
        thread_id: 'forum_794ab7f8-9341-4903-a889-c2bda551d93d',
      },
      messageCount: 4,
      newMessageCount: 0,
      originalPoster: '116514945',
    },
    {
      id: 'forum_d4b1213e-731d-4e22-a512-c7f6429ff977',
      external_id: 'd4b1213e-731d-4e22-a512-c7f6429ff977',
      thread_type: 'forum',
      title: 'Когда вернется TPOL?',
      views: 147,
      pinned: false,
      admin_only: false,
      lastMessage: {
        id: 'e87f6ecc-0bd3-4f0f-93f1-cc617398aa57',
        author: '898733034',
        index: 0,
        content: 'Когда вернется TPOL?',
        created_at: '2024-10-30T15:26:21.886Z',
        deleted: false,
        thread_id: 'forum_d4b1213e-731d-4e22-a512-c7f6429ff977',
      },
      messageCount: 1,
      newMessageCount: 0,
      originalPoster: '898733034',
    },
    {
      id: 'forum_5eab21a7-94eb-4c16-87b0-1918f9577d9d',
      external_id: '5eab21a7-94eb-4c16-87b0-1918f9577d9d',
      thread_type: 'forum',
      title: 'ленне соси',
      views: 144,
      pinned: false,
      admin_only: false,
      lastMessage: {
        id: '459b893c-e5a3-4eb0-87f5-fbba1cb8e219',
        author: '837378654',
        index: 0,
        content: 'ленне соси',
        created_at: '2024-10-30T15:05:30.133Z',
        deleted: false,
        thread_id: 'forum_5eab21a7-94eb-4c16-87b0-1918f9577d9d',
      },
      messageCount: 1,
      newMessageCount: 0,
      originalPoster: '837378654',
    },
    {
      id: 'forum_0bc4e15b-6c65-41d7-985c-925187f924b0',
      external_id: '0bc4e15b-6c65-41d7-985c-925187f924b0',
      thread_type: 'forum',
      title: 'клор опять лучше всех',
      views: 151,
      pinned: false,
      admin_only: false,
      lastMessage: {
        id: 'ef1755bb-40ce-43d5-96d5-cfe46ff7eefb',
        author: '1126848000',
        index: 0,
        content: 'ДА\n!!1',
        created_at: '2024-10-28T17:59:04.777Z',
        deleted: false,
        thread_id: 'forum_0bc4e15b-6c65-41d7-985c-925187f924b0',
      },
      messageCount: 1,
      newMessageCount: 0,
      originalPoster: '1126848000',
    },
    {
      id: 'forum_b947676f-273f-4c67-bd80-574d76376d56',
      external_id: 'b947676f-273f-4c67-bd80-574d76376d56',
      thread_type: 'forum',
      title: 'Название топика',
      views: 158,
      pinned: false,
      admin_only: false,
      lastMessage: {
        id: '0c02deae-4a94-406d-baf9-57daf40b93eb',
        author: '905422862',
        index: 0,
        content: 'Сообщение',
        created_at: '2024-10-02T12:24:37.591Z',
        deleted: false,
        thread_id: 'forum_b947676f-273f-4c67-bd80-574d76376d56',
      },
      messageCount: 1,
      newMessageCount: 0,
      originalPoster: '905422862',
    },
  ],
  16,
];

async function bootstrap() {
  await otelSDK.start();
  const app = await NestFactory.create(AppModule);
  app.connectMicroservice({
    transport: Transport.REDIS,
    options: {
      host: REDIS_HOST(),
      port: REDIS_PORT(),
      retryAttempts: Infinity,
      retryDelay: 5000,
      password: REDIS_PASSWORD(),
    },
  });

  const options = new DocumentBuilder()
    .setTitle('GameServer api')
    .setDescription('Matches, players, mmrs')
    .setVersion('1.0')
    .addBearerAuth()
    .build();
  const document = SwaggerModule.createDocument(app, options);
  SwaggerModule.setup('api', app, document);

  await app.listen(6009);

  await app.startAllMicroservices();
}
bootstrap();
